---
title: "ERCC2"
author: "jerod"
date: "June 28, 2016"
output: html_document
---

This analysis automates the map/build/analysis of ERCC2.0 reference datasets.
Most of the compute is intended to be performed on the cloud via predeveloped 7BG pipelines.
This is streamlined by the utilization of the API from R.
#Step 1:  Upload
First we need to know where your files are.  We assume they're present in a directory
called 'fastq' underneath the working directory
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = TRUE)#better to not repeat
```

```{r}
#fastqdir<-"fastq/"
fastqdir<-"/Volumes/Archive2b/RawData/HSMagicMix/fastq/"
fastqlist<-list.files(path = fastqdir,pattern = ".fastq*")
erccproject="prototypeercc2"
```
Second we need to collect some metadata.  Fill out the table metadatatable.txt with information
appropriate to your site:

```{r}
fastqmetadata<-read.table(file="metadatatable.txt",sep=",",stringsAsFactors = FALSE,header = TRUE)
head(fastqmetadata)
```

Then we need to upload them to the cloud for processing.  This will likely go through several iterations of issues.
```{r, echo=FALSE}
##my api token.  Will need to update before doing any major processing [but should be okay for this 1 HS run]
require(sevenbridges)
sevenbridgesapitoken="68916d51f8ba48c1a87a47f135bafef0"
authurl="https://api.sbgenomics.com/v2/"
a<-Auth(sevenbridgesapitoken,url=authurl)
p<-a$project(name = erccproject)

require("devtools")||install.packages("devtools");require("devtools")
require("sevenbridges")#available on bioconductor -- we're hoping to make this all as a pre-setup VM...
for(fastq in fastqlist){
  if(is.null(p$file(name=fastq)))#check to see if it's already in the cloud folder.  Tested, working.  
    {
#actually check that the file was successfully uploaded
    #wrap this in tryCatch so that when it has errors [as it invariably will], it doesn't murder the compilation.
    tryCatch({
    p$upload(filename = paste0(fastqdir,fastq),metadata=as.list(fastqmetadata[fastqmetadata$Fastq_filename==fastq,2:length(fastqmetadata)])) ##metadata is not registering properly.
      
      error=function(err){
        #check if the file is partial
        fid=p$file(name=fastq)[[1]]$id
        localsize=file.info(paste0(fastqdir,fastq))$size
        remotesize=p$file(id=fid)$size
        if(remotesize<localsize)
        #remove the partial file
        p$delete(id=fid)
      }
    })
  }
  }


```
